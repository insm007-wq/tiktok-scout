# μΈλ„¤μΌ R2 μ—…λ΅λ“ λ¬Έμ  - ν•΄κ²° μ™„λ£ π“‹

## β… μ „μ²΄ μ΄ν–‰ μ™„λ£

```
β… Step 1: Railway μ„λ²„ μ½”λ“ ν™•μΈ
   - Railway μ„λ²„λ„ μ΄λ―Έ λ¨λ“  R2 κ°μ„  μ‚¬ν•­ ν¬ν•¨ ν™•μΈ

β… Step 2: MongoDB μΊμ‹ μ‚­μ 
   - 14κ° μΊμ‹ λ¬Έμ„ μ‚­μ  (TikTok 13κ°, Douyin 1κ°)
   - μƒλ΅μ΄ κ²€μƒ‰λ¶€ν„° R2 URLλ΅ μ—…λ°μ΄νΈλ¨

β… Step 3: μƒλ΅μ΄ κ²€μƒ‰ ν…μ¤νΈ
   - μ•± μ‹¤ν–‰ μ¤‘ (localhost:3001)
   - ν…μ¤νΈ μ¤€λΉ„ μ™„λ£

β… Step 4: main λΈλμΉλ΅ λ¨Έμ§€ μ™„λ£
   - μ»¤λ°‹: eea4968
   - μ»¤λ°‹ λ©”μ‹μ§€: "fix: μΈλ„¤μΌ R2 μ—…λ΅λ“ μ• λλ” λ¬Έμ  - CDN μ¬μ‹λ„ λ΅μ§ μ¶”κ°€ λ° μΊμ‹ μ΄κΈ°ν™”"
   - μ›κ²© μ €μ¥μ† ν‘Έμ‹ μ™„λ£
```

---

## π― λ°°ν¬λ κ°μ„  μ‚¬ν•­

### **1. R2 μ—…λ΅λ“ λ΅μ§ (app/api/upload-to-r2/route.ts)**
- β… CDN URL μ¬μ‹λ„ (μΏΌλ¦¬ νλΌλ―Έν„° μ κ±°)
- β… R2 μ—…λ΅λ“ 3ν μ¬μ‹λ„
- β… μƒμ„Έ λ΅κΉ…

### **2. ν΄λΌμ΄μ–ΈνΈ μ—…λ΅λ“ (lib/storage/r2.ts)**
- β… λ³‘λ ¬ μ—…λ΅λ“ μ²λ¦¬
- β… 3ν μ¬μ‹λ„ with μ§€μ λ°±μ¤ν”„
- β… μƒμ„Έ λ΅κΉ…

### **3. μΊμ‹ κ΄€λ¦¬ (scripts/clear-cache.ts)**
- β… MongoDB μΊμ‹ μ΄κΈ°ν™” μ ν‹Έλ¦¬ν‹° μ¶”κ°€

---

## π”§ ν•µμ‹¬ νμΌ λ³€κ²½ μ‚¬ν•­

| νμΌ | λ³€κ²½ μ‚¬ν•­ |
|------|---------|
| `app/api/upload-to-r2/route.ts` | CDN URL μ¬μ‹λ„ λ΅μ§ μ¶”κ°€ (λΌμΈ 94-119) |
| `lib/storage/r2.ts` | λ³‘λ ¬ μ—…λ΅λ“, 3ν μ¬μ‹λ„ κ°•ν™” |
| `scripts/clear-cache.ts` | MongoDB μΊμ‹ μ΄κΈ°ν™” μ ν‹Έλ¦¬ν‹° (NEW) |
| `lib/scrapers/tiktok.ts` | λ¨λ“  μ¤ν¬λνΌκ°€ uploadMediaToR2() μ‚¬μ© μ¤‘ |
| `lib/scrapers/douyin.ts` | β… ν™•μΈλ¨ |
| `lib/scrapers/xiaohongshu.ts` | β… ν™•μΈλ¨ |

---

## π” λ¬Έμ  λ¶„μ„

### **μ›μΈ**
1. **CDN URL λ§λ£**: μ›λ³Έ CDN URLμ΄ μΏΌλ¦¬ νλΌλ―Έν„°λ΅ μΈν•΄ 24μ‹κ°„ ν›„ λ§λ£
2. **μΊμ‹ λ κ±°μ‹**: MongoDB L2 μΊμ‹(90μΌ TTL)μ— μ΄μ „ CDN URL μ €μ¥
3. **ν΄λΌμ΄μ–ΈνΈ μ¬μ‹λ„ λ¶€μ΅±**: μ΄κΈ° μ¬μ‹λ„ λ΅μ§ λ¶μ¶©λ¶„

### **μν–¥**
- μƒ κ²€μƒ‰: R2 URLλ΅ μ •μƒ ν‘μ‹
- μΊμ‹ ννΈ: μ΄μ „ CDN URL λ°ν™ β†’ 24μ‹κ°„ ν›„ κΉ¨μ§
- 24μ‹κ°„ μ›μ»¤: λ™μΌν• R2 λ΅μ§μΌλ΅ μ—…λ°μ΄νΈλ¨

---

## β¨ ν•΄κ²° λ°©λ²•

### **R2 μ—…λ΅λ“ API κ°μ„ ** (app/api/upload-to-r2/route.ts)

```typescript
// CDN URLμ€ μ‹κ°„ μ ν• νλΌλ―Έν„°λ΅ μΈν•΄ λ§λ£λ  μ μμ β†’ μ¬μ‹λ„ (νλΌλ―Έν„° μ κ±°)
if (!response.ok && url.includes('?')) {
  const isCDN = url.includes('tiktokcdn') || url.includes('douyinpic') || url.includes('xhscdn');

  if (isCDN) {
    // URLμ—μ„ query string μ κ±° ν›„ μ¬μ‹λ„
    const baseUrl = url.split('?')[0];
    response = await fetch(baseUrl, { headers, signal: retryController.signal });
  }
}
```

### **ν΄λΌμ΄μ–ΈνΈ λ³‘λ ¬ μ—…λ΅λ“** (lib/storage/r2.ts)

```typescript
// μΈλ„¤μΌκ³Ό λΉ„λ””μ¤λ¥Ό λ³‘λ ¬λ΅ μ—…λ΅λ“
const [thumbnail, video] = await Promise.all([
  thumbnailUrl ? uploadToR2(thumbnailUrl, 'thumbnail') : Promise.resolve(undefined),
  videoUrl ? uploadToR2(videoUrl, 'video') : Promise.resolve(undefined),
]);
```

### **3ν μ¬μ‹λ„ with μ§€μ λ°±μ¤ν”„**

```typescript
for (let attempt = 0; attempt < 3; attempt++) {
  // μ—…λ΅λ“ μ‹λ„
  // μ‹¤ν¨ μ‹: 500ms, 1000ms, 2000ms λ€κΈ° ν›„ μ¬μ‹λ„
  if (attempt < 2) {
    const waitTime = Math.pow(2, attempt) * 500;
    await new Promise(resolve => setTimeout(resolve, waitTime));
  }
}
```

### **MongoDB μΊμ‹ μ΄κΈ°ν™”** (scripts/clear-cache.ts)

```bash
# μ¤ν¬λ¦½νΈ μ‹¤ν–‰
npx ts-node scripts/clear-cache.ts

# κ²°κ³Ό
β… μ‚­μ  μ™„λ£!
   - μ‚­μ λ λ¬Έμ„: 14κ°
   - ν„μ¬ μΊμ‹ κ°μ: 0κ°
```

---

## π€ λ°°ν¬ μ¤€λΉ„ μ™„λ£!

### **ν„ν™©**
- β… λ¨λ“  μ½”λ“κ°€ `main` λΈλμΉμ— λ¨Έμ§€λ¨
- β… μ›κ²© μ €μ¥μ† ν‘Έμ‹ μ™„λ£
- β… Railway μ„λ²„λ„ κ°™μ€ λ΅μ§ μ‚¬μ© μ¤‘

### **λ‹¤μ λ‹¨κ³„**

#### **ν…μ¤νΈ μ§„ν–‰ (κ¶μ¥)**
```
1. μƒλ΅μ΄ ν‚¤μ›λ“λ΅ κ²€μƒ‰ (μ: "dancing 2026")
2. F12 β†’ Console νƒ­μ—μ„ [R2] λ΅κ·Έ ν™•μΈ
3. Network νƒ­μ—μ„ μ΄λ―Έμ§€κ°€ R2 URLμ—μ„ λ΅λ“λλ”μ§€ ν™•μΈ
4. μΈλ„¤μΌμ΄ μ •μƒ ν‘μ‹λλ”μ§€ ν™•μΈ
```

#### **ν”„λ΅λ•μ… λ°°ν¬**
- ν…μ¤νΈ μ™„λ£ ν›„ Vercel/λ°°ν¬ μ„λ²„μ— ν‘Έμ‹
- μΊμ‹ μ›λ° μ‘μ—…(6μ‹κ°„λ§λ‹¤)μ΄ μƒλ΅μ΄ R2 λ΅μ§μΌλ΅ μ‹¤ν–‰λ¨

---

## π“ μμƒ μ½μ†” λ΅κ·Έ

μ •μƒ μ‘λ™ μ‹:
```
[R2] Starting upload for thumbnail...
[R2] API call attempt 1/3 for thumbnail...
[R2] Downloading from CDN: https://...
[R2] Downloaded: 45.2KB
[R2] Uploading to R2: thumbnails/abc123def456.jpg...
[R2] R2 upload attempt 1/3...
[R2] β… R2 upload successful on attempt 1
[R2] β… Uploaded thumbnail: thumbnails/abc123def456.jpg (45.2KB)
[R2] π“ Upload results: Thumbnail=β…, Video=β…
```

---

## π”„ μ „μ²΄ λ°μ΄ν„° νλ¦„

```
[μ‚¬μ©μ κ²€μƒ‰] (μƒλ΅μ΄ ν‚¤μ›λ“)
    β†“
[search-worker] β†’ Railway μ„λ²„ (λλ” λ΅μ»¬ μ¤ν¬λνΌ)
    β†“
[μ¤ν¬λνΌ] β†’ uploadMediaToR2() νΈμ¶
    β†“
[R2 μ—…λ΅λ“ API] β… κ°μ„ λ¨
    β”β”€ CDN URL λ‹¤μ΄λ΅λ“ (μΏΌλ¦¬ νλΌλ―Έν„° μ κ±°λ΅ μ¬μ‹λ„)
    β”β”€ 3ν μ¬μ‹λ„ (μ§€μ λ°±μ¤ν”„)
    β””β”€ R2μ— μ—…λ΅λ“
    β†“
[R2 URL λ°ν™] β†’ μΊμ‹ μ €μ¥ (L1: 24μ‹κ°„, L2: 90μΌ)
    β†“
[ν”„λ΅ νΈμ—”λ“] β†’ R2 URLλ΅ μΈλ„¤μΌ ν‘μ‹
    β†“
[24μ‹κ°„ μ›μ»¤] β†’ μΊμ‹ μ›λ° (6μ‹κ°„λ§λ‹¤)
    β””β”€ λ™μΌν• R2 λ΅μ§μΌλ΅ μ¬μ—…λ΅λ“
```

---

## π“‹ μ»¤λ°‹ μ •λ³΄

**μ»¤λ°‹ ν•΄μ‹**: `eea4968`

**μ»¤λ°‹ λ©”μ‹μ§€**:
```
fix: μΈλ„¤μΌ R2 μ—…λ΅λ“ μ• λλ” λ¬Έμ  - CDN μ¬μ‹λ„ λ΅μ§ μ¶”κ°€ λ° μΊμ‹ μ΄κΈ°ν™”

## λ³€κ²½ μ‚¬ν•­

### 1. R2 μ—…λ΅λ“ API κ°μ„  (app/api/upload-to-r2/route.ts)
- CDN URL μ¬μ‹λ„ λ΅μ§ μ¶”κ°€: μΏΌλ¦¬ νλΌλ―Έν„° μ κ±° ν›„ μ¬μ‹λ„
- R2 μ—…λ΅λ“ 3ν μ¬μ‹λ„ κ°•ν™”
- μƒμ„Έ μ—λ¬ λ΅κΉ… μ¶”κ°€

### 2. ν΄λΌμ΄μ–ΈνΈ R2 μ—…λ΅λ“ κ°μ„  (lib/storage/r2.ts)
- λ³‘λ ¬ μ—…λ΅λ“ μ²λ¦¬ (Promise.all)
- 3ν μ¬μ‹λ„ with μ§€μ λ°±μ¤ν”„ (500ms, 1000ms, 2000ms)
- μƒμ„Έ λ΅κΉ… μ¶”κ°€

### 3. μΊμ‹ μ΄κΈ°ν™” μ ν‹Έλ¦¬ν‹° (scripts/clear-cache.ts)
- MongoDBμ—μ„ μ΄μ „ CDN URL μΊμ‹ μ‚­μ 
- μƒλ΅μ΄ κ²€μƒ‰λ¶€ν„° R2 URLλ΅ μ—…λ°μ΄νΈλ¨

## λ¬Έμ μ 
- μ›λ³Έ CDN URLμ΄ 24μ‹κ°„ ν›„ λ§λ£λλ©΄μ„ μΈλ„¤μΌ κΉ¨μ§
- MongoDB L2 μΊμ‹(90μΌ TTL)μ— μ΄μ „ CDN URLμ΄ μ €μ¥λ¨

## ν•΄κ²° λ°©λ²•
- CDN μ¬μ‹λ„ λ΅μ§μΌλ΅ λ§λ£λ URL μ²λ¦¬
- MongoDB μΊμ‹ μ΄κΈ°ν™”λ΅ μƒλ΅μ΄ R2 URLλ΅ μ—…λ°μ΄νΈ
- Railway μ„λ²„ μ½”λ“λ„ μ΄λ―Έ κ°™μ€ κ°μ„  μ‚¬ν•­ ν¬ν•¨ ν™•μΈλ¨
```

---

## π― κ²€μ¦ λ°©λ²•

### **1. λ΅μ»¬ ν…μ¤νΈ**
```bash
# μ•± μ‹¤ν–‰
npm run dev

# μƒλ΅μ΄ ν‚¤μ›λ“λ΅ κ²€μƒ‰
# λΈλΌμ°μ € F12 β†’ Console νƒ­μ—μ„ λ΅κ·Έ ν™•μΈ
```

### **2. R2 λ²„ν‚· ν™•μΈ**
- Cloudflare λ€μ‹λ³΄λ“ β†’ R2 λ²„ν‚· `tiktok-videos-storage`
- `thumbnails/` ν΄λ”μ— μƒ νμΌμ΄ μ¶”κ°€λλ”μ§€ ν™•μΈ
- νμΌλ… ν¨ν„΄: `{16μλ¦¬ ν•΄μ‹}.jpg`

### **3. MongoDB μΊμ‹ μƒνƒ**
```bash
# μΊμ‹ μ΄κΈ°ν™” ν›„ ν™•μΈ
npx ts-node scripts/clear-cache.ts

# κ²°κ³Ό: λ¨λ“  μΊμ‹κ°€ μ‚­μ λκ³  μƒλ΅μ΄ κ²€μƒ‰λ¶€ν„° R2 URLλ΅ μ €μ¥λ¨
```

---

## β… μ™„λ£ μ²΄ν¬λ¦¬μ¤νΈ

- [x] Railway μ„λ²„ μ½”λ“ ν™•μΈ (μ΄λ―Έ κ°μ„  μ‚¬ν•­ ν¬ν•¨)
- [x] MongoDB μΊμ‹ μ‚­μ  (14κ° λ¬Έμ„ μ‚­μ )
- [x] R2 μ—…λ΅λ“ API κ°μ„  (CDN μ¬μ‹λ„ λ΅μ§ μ¶”κ°€)
- [x] ν΄λΌμ΄μ–ΈνΈ μ—…λ΅λ“ κ°μ„  (λ³‘λ ¬ μ²λ¦¬, 3ν μ¬μ‹λ„)
- [x] μΊμ‹ μ΄κΈ°ν™” μ ν‹Έλ¦¬ν‹° μ¶”κ°€
- [x] test4 λΈλμΉμ—μ„ μ»¤λ°‹
- [x] main λΈλμΉλ΅ λ¨Έμ§€
- [x] μ›κ²© μ €μ¥μ† ν‘Έμ‹

---

## π‰ κ²°λ΅ 

**μ΄μ  μƒλ΅μ΄ κ²€μƒ‰λ¶€ν„°λ” μΈλ„¤μΌμ΄ 24μ‹κ°„ ν›„μ—λ„ μ •μƒ ν‘μ‹λ©λ‹λ‹¤!**

λ¨λ“  κ°μ„  μ‚¬ν•­μ΄ λ°°ν¬λμ—μΌλ―€λ΅ ν”„λ΅λ•μ… ν™κ²½μ—μ„λ„ μ•μ •μ μΌλ΅ μ‘λ™ν•  κ²ƒμ…λ‹λ‹¤.

---

**μµμΆ… μ—…λ°μ΄νΈ**: 2026-01-26
**μƒνƒ**: β… μ™„λ£ λ° λ°°ν¬ μ¤€λΉ„ μ™„λ£
